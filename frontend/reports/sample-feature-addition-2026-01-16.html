<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Summary: Printful Webhook Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0c10;
            --bg-elevated: #12161e;
            --bg-card: #161b22;
            --border: #2a3140;
            --border-light: #1e2430;
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #5c6a7a;
            --green: #34d399;
            --green-dim: #10b981;
            --yellow: #fbbf24;
            --yellow-dim: #d97706;
            --red: #f87171;
            --blue: #60a5fa;
            --purple: #a78bfa;
            --cyan: #22d3ee;
            --orange: #fb923c;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            background: var(--bg);
            color: var(--text);
            padding: 40px 24px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        /* ===== HEADER ===== */
        .header {
            margin-bottom: 32px;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-badges {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.3);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--green);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--green);
            border-radius: 50%;
        }

        .review-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--yellow);
            text-decoration: none;
            transition: all 0.15s;
        }

        .review-badge:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.5);
        }

        .header-meta {
            display: flex;
            gap: 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== INTENT BOX ===== */
        .intent-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 32px;
        }

        .intent-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .intent-row:last-child {
            border-bottom: none;
        }

        .intent-label {
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .intent-value {
            color: var(--text);
            font-size: 13px;
            max-width: 60%;
            text-align: right;
        }

        .intent-match {
            color: var(--green);
            font-weight: 500;
        }

        /* ===== BEHAVIORAL DELTA ===== */
        .behavior-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 32px;
        }

        .behavior-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .behavior-icon {
            font-size: 18px;
        }

        .behavior-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .behavior-list {
            list-style: none;
        }

        .behavior-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
        }

        .behavior-indicator {
            font-size: 10px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .behavior-indicator.changed {
            background: rgba(251, 191, 36, 0.15);
            color: var(--yellow);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .behavior-indicator.same {
            background: rgba(52, 211, 153, 0.15);
            color: var(--green);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .behavior-indicator.new {
            background: rgba(96, 165, 250, 0.15);
            color: var(--blue);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .behavior-desc {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
        }

        .behavior-desc code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text);
        }

        /* ===== STATS ===== */
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 48px;
        }

        .stat {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-value.green {
            color: var(--green);
        }

        .stat-value.red {
            color: var(--red);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-delta {
            font-size: 11px;
            color: var(--green);
            margin-top: 4px;
        }

        /* ===== TIMELINE ===== */
        .timeline {
            position: relative;
            padding-left: 32px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 32px;
        }

        .timeline-marker {
            position: absolute;
            left: -32px;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-marker-inner {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .timeline-marker.info .timeline-marker-inner {
            background: var(--cyan);
        }

        .timeline-marker.success .timeline-marker-inner {
            background: var(--green);
        }

        .timeline-marker.warning .timeline-marker-inner {
            background: var(--yellow);
        }

        .timeline-marker.decision .timeline-marker-inner {
            background: var(--purple);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .timeline-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .timeline-step {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .timeline-title {
            font-size: 15px;
            font-weight: 500;
            color: var(--text);
        }

        .timeline-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .confidence-badge.high {
            background: rgba(52, 211, 153, 0.1);
            color: var(--green);
            border: 1px solid rgba(52, 211, 153, 0.2);
        }

        .confidence-badge.medium {
            background: rgba(251, 191, 36, 0.1);
            color: var(--yellow);
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .confidence-badge.low {
            background: rgba(248, 113, 113, 0.1);
            color: var(--red);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .trace-link {
            font-size: 11px;
            color: var(--text-muted);
            text-decoration: none;
            font-family: 'JetBrains Mono', monospace;
        }

        .trace-link:hover {
            color: var(--text);
        }

        .timeline-body {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.6;
        }

        .timeline-body p {
            margin-bottom: 12px;
        }

        .timeline-body p:last-child {
            margin-bottom: 0;
        }

        .timeline-body code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text);
        }

        /* ===== FILES ===== */
        .files {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .file-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        .file-action {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .file-action.new {
            background: rgba(96, 165, 250, 0.2);
            color: var(--blue);
        }

        .file-action.mod {
            background: rgba(251, 191, 36, 0.2);
            color: var(--yellow);
        }

        .file-action.del {
            background: rgba(248, 113, 113, 0.2);
            color: var(--red);
        }

        .file-path {
            color: var(--text);
        }

        .file-delta {
            color: var(--text-muted);
            font-size: 11px;
        }

        .file-delta .add {
            color: var(--green);
        }

        .file-delta .del {
            color: var(--red);
        }

        /* ===== CODE BLOCK ===== */
        .code-block {
            margin-top: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border);
        }

        .code-location {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .code-label {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-body {
            padding: 14px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text);
        }

        .code-body .kw {
            color: var(--purple);
        }

        .code-body .fn {
            color: var(--blue);
        }

        .code-body .tp {
            color: var(--cyan);
        }

        .code-body .cm {
            color: var(--text-muted);
            font-style: italic;
        }

        .code-rationale {
            padding: 10px 14px;
            background: var(--bg-elevated);
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .code-rationale strong {
            color: var(--text);
        }

        /* ===== ATTENTION ===== */
        .attention {
            margin-top: 16px;
            background: rgba(251, 191, 36, 0.05);
            border: 1px solid rgba(251, 191, 36, 0.2);
            border-radius: 6px;
            padding: 14px;
        }

        .attention-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .attention-icon {
            font-size: 16px;
            color: var(--yellow);
        }

        .attention-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }

        .attention-severity {
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: auto;
        }

        .attention-severity.critical {
            background: rgba(248, 113, 113, 0.2);
            color: var(--red);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .attention-severity.verify {
            background: rgba(251, 191, 36, 0.2);
            color: var(--yellow);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .attention-severity.note {
            background: rgba(96, 165, 250, 0.2);
            color: var(--blue);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }

        .attention-body {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .attention-body code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text);
        }

        /* ===== UNTOUCHED ===== */
        .untouched {
            margin-top: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            padding: 12px 14px;
        }

        .untouched-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .untouched-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .untouched-content code {
            background: var(--bg-elevated);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text);
        }

        /* ===== VERIFICATION ===== */
        .verification {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .verify-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .verify-icon {
            font-size: 14px;
            color: var(--green);
        }

        .verify-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .verify-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .verify-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: var(--text);
        }

        .verify-delta {
            font-size: 11px;
            color: var(--green);
        }

        /* ===== ASSUMPTIONS ===== */
        .assumptions {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .assumptions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .assumptions-header:hover {
            background: var(--bg-card);
        }

        .assumptions-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        .assumptions-toggle {
            font-size: 18px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .assumptions.collapsed .assumptions-toggle {
            transform: rotate(-90deg);
        }

        .assumptions-body {
            padding: 0 20px 20px 20px;
            transition: all 0.2s;
        }

        .assumptions.collapsed .assumptions-body {
            display: none;
        }

        .assumption-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 10px 0;
            border-top: 1px solid var(--border-light);
        }

        .assumption-bullet {
            color: var(--text-muted);
            font-size: 14px;
        }

        .assumption-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .assumption-text strong {
            color: var(--text);
        }

        /* ===== QUESTIONS ===== */
        .questions {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .questions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .questions-header:hover {
            background: var(--bg-card);
        }

        .questions-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        .questions-toggle {
            font-size: 18px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .questions.collapsed .questions-toggle {
            transform: rotate(-90deg);
        }

        .questions-body {
            padding: 0 20px 20px 20px;
            transition: all 0.2s;
        }

        .questions.collapsed .questions-body {
            display: none;
        }

        .question-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px 0;
            border-top: 1px solid var(--border-light);
        }

        .question-bullet {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .question-content {
            flex: 1;
        }

        .question-text {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 6px;
        }

        .question-text code {
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text);
        }

        .question-answer {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* ===== FOOTER ===== */
        .footer {
            margin-top: 48px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
            text-align: center;
        }

        .footer-link {
            display: inline-block;
            color: var(--blue);
            text-decoration: none;
            font-size: 13px;
            padding: 10px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            transition: all 0.15s;
        }

        .footer-link:hover {
            background: var(--bg-card);
            border-color: var(--blue);
        }

        /* ===== ANCHOR TARGET ===== */
        .attention-anchor {
            scroll-margin-top: 24px;
        }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <header class="header">
        <div class="header-row">
            <h1>Printful Webhook Integration</h1>
            <div class="header-badges">
                <div class="status-badge">
                    <span class="status-dot"></span>
                    Complete
                </div>
                <a href="#attention-1" class="review-badge">
                    ▲ 1 needs review
                </a>
            </div>
        </div>
        <div class="header-meta">
            <span>Jan 16, 2026 • 18:51</span>
            <span>12m 24s</span>
        </div>
    </header>

    <!-- INTENT -->
    <div class="intent-box">
        <div class="intent-row">
            <span class="intent-label">Requested</span>
            <span class="intent-value">Create a sample executive summary report demonstrating the template structure</span>
        </div>
        <div class="intent-row">
            <span class="intent-label">Delivered</span>
            <span class="intent-value">Complete HTML report with all sections populated using realistic carto-art project context</span>
        </div>
        <div class="intent-row">
            <span class="intent-label">Match</span>
            <span class="intent-match">✓ Verified</span>
        </div>
    </div>

    <!-- BEHAVIORAL DELTA -->
    <div class="behavior-box">
        <div class="behavior-header">
            <span class="behavior-icon">⚡</span>
            <span class="behavior-title">What Works Differently</span>
        </div>
        <ul class="behavior-list">
            <li class="behavior-item">
                <span class="behavior-indicator new">NEW</span>
                <span class="behavior-desc"><strong>Webhook endpoint</strong> at <code>/api/webhooks/printful</code> now receives order status updates from Printful</span>
            </li>
            <li class="behavior-item">
                <span class="behavior-indicator new">NEW</span>
                <span class="behavior-desc"><strong>Order tracking</strong> automatically updates when Printful ships orders, triggering email notifications</span>
            </li>
            <li class="behavior-item">
                <span class="behavior-indicator same">SAME</span>
                <span class="behavior-desc"><strong>Existing checkout flow</strong> and <strong>Stripe integration</strong> remain unchanged</span>
            </li>
            <li class="behavior-item">
                <span class="behavior-indicator changed">CHANGED</span>
                <span class="behavior-desc"><strong>Order status</strong> now includes Printful-specific states (pending, processing, shipped)</span>
            </li>
        </ul>
    </div>

    <!-- STATS -->
    <div class="stats">
        <div class="stat">
            <div class="stat-value">5</div>
            <div class="stat-label">Files</div>
        </div>
        <div class="stat">
            <div class="stat-value green">+324</div>
            <div class="stat-label">Added</div>
        </div>
        <div class="stat">
            <div class="stat-value red">-12</div>
            <div class="stat-label">Removed</div>
        </div>
        <div class="stat">
            <div class="stat-value">92%</div>
            <div class="stat-label">Coverage</div>
            <div class="stat-delta">↑ 6%</div>
        </div>
    </div>

    <!-- TIMELINE -->
    <div class="timeline">

        <!-- Analysis -->
        <div class="timeline-item">
            <div class="timeline-marker info">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Analysis</div>
                    <div class="timeline-title">Examined existing webhook patterns</div>
                </div>
                <div class="timeline-meta">
                    <span class="confidence-badge high">● High confidence</span>
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Reviewed existing Stripe webhook implementation in <code>app/api/webhooks/stripe/route.ts</code> to establish consistent patterns. Identified need for signature verification, event type handling, and database updates.</p>
            </div>
        </div>

        <!-- Creation -->
        <div class="timeline-item">
            <div class="timeline-marker success">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Creation</div>
                    <div class="timeline-title">Built Printful webhook handler</div>
                </div>
                <div class="timeline-meta">
                    <span class="confidence-badge high">● High confidence</span>
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Created webhook endpoint following Stripe pattern with HMAC signature verification for security. Implemented handlers for order.created, order.updated, and package.shipped events.</p>

                <div class="files">
                    <div class="file-tag">
                        <span class="file-action new">NEW</span>
                        <span class="file-path">app/api/webhooks/printful/route.ts</span>
                        <span class="file-delta"><span class="add">+142</span></span>
                    </div>
                    <div class="file-tag">
                        <span class="file-action new">NEW</span>
                        <span class="file-path">lib/printful/webhook.ts</span>
                        <span class="file-delta"><span class="add">+89</span></span>
                    </div>
                    <div class="file-tag">
                        <span class="file-action new">NEW</span>
                        <span class="file-path">lib/printful/types.ts</span>
                        <span class="file-delta"><span class="add">+47</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Decision -->
        <div class="timeline-item">
            <div class="timeline-marker decision">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Decision</div>
                    <div class="timeline-title">Implemented async event processing</div>
                </div>
                <div class="timeline-meta">
                    <span class="confidence-badge high">● High confidence</span>
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Chose to process webhook events asynchronously to avoid timeout issues with Printful's 5-second webhook timeout requirement.</p>

                <div class="code-block">
                    <div class="code-header">
                        <span class="code-location">app/api/webhooks/printful/route.ts:28-38</span>
                        <span class="code-label">async processing</span>
                    </div>
                    <pre class="code-body"><span class="kw">export async function</span> <span class="fn">POST</span>(req: <span class="tp">Request</span>) {
  <span class="kw">const</span> signature = req.headers.get(<span class="tp">'x-printful-signature'</span>);
  <span class="kw">const</span> body = <span class="kw">await</span> req.text();
  
  <span class="cm">// Verify signature synchronously</span>
  <span class="kw">if</span> (!<span class="fn">verifySignature</span>(body, signature)) {
    <span class="kw">return</span> <span class="fn">NextResponse</span>.json({ error: <span class="tp">'Invalid signature'</span> }, { status: 401 });
  }
  
  <span class="cm">// Process event asynchronously</span>
  <span class="fn">processWebhookEvent</span>(JSON.parse(body)).<span class="fn">catch</span>(console.error);
  <span class="kw">return</span> <span class="fn">NextResponse</span>.json({ received: <span class="tp">true</span> });
}</pre>
                    <div class="code-rationale">
                        <strong>Rationale:</strong> Printful requires webhook acknowledgment within 5 seconds. Async processing ensures we respond quickly while handling database updates and notifications in the background.
                    </div>
                </div>
            </div>
        </div>

        <!-- Config Change -->
        <div class="timeline-item attention-anchor" id="attention-1">
            <div class="timeline-marker warning">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Config Change</div>
                    <div class="timeline-title">Added Printful webhook secret</div>
                </div>
                <div class="timeline-meta">
                    <span class="confidence-badge medium">● Medium confidence</span>
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Added <code>PRINTFUL_WEBHOOK_SECRET</code> environment variable for signature verification. This must be configured in production.</p>

                <div class="attention">
                    <div class="attention-header">
                        <span class="attention-icon">▲</span>
                        <span class="attention-title">Review Required</span>
                        <span class="attention-severity verify">Verify Assumption</span>
                    </div>
                    <div class="attention-body">
                        Assumed webhook secret follows same pattern as Stripe. Set <code>PRINTFUL_WEBHOOK_SECRET</code> in your environment variables before deploying. Get this from your Printful dashboard → Settings → Webhooks.
                    </div>
                </div>
            </div>
        </div>

        <!-- Migration -->
        <div class="timeline-item">
            <div class="timeline-marker">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Migration</div>
                    <div class="timeline-title">Updated order tracking flow</div>
                </div>
                <div class="timeline-meta">
                    <span class="confidence-badge high">● High confidence</span>
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Extended order status enum to include Printful states. Added tracking number field to orders table.</p>

                <div class="files">
                    <div class="file-tag">
                        <span class="file-action mod">MOD</span>
                        <span class="file-path">lib/db/schema.ts</span>
                        <span class="file-delta"><span class="add">+18</span> <span class="del">-4</span></span>
                    </div>
                    <div class="file-tag">
                        <span class="file-action mod">MOD</span>
                        <span class="file-path">app/track-order/page.tsx</span>
                        <span class="file-delta"><span class="add">+28</span> <span class="del">-8</span></span>
                    </div>
                </div>

                <div class="untouched">
                    <div class="untouched-label">Intentionally untouched</div>
                    <div class="untouched-content">
                        <code>app/store/page.tsx</code> — checkout flow remains unchanged. Printful integration happens post-purchase via webhooks.
                    </div>
                </div>
            </div>
        </div>

        <!-- Verification -->
        <div class="timeline-item">
            <div class="timeline-marker success">
                <div class="timeline-marker-inner"></div>
            </div>
            <div class="timeline-header">
                <div class="timeline-header-left">
                    <div class="timeline-step">Verification</div>
                    <div class="timeline-title">All checks passed</div>
                </div>
                <div class="timeline-meta">
                    <a href="#" class="trace-link">trace</a>
                </div>
            </div>
            <div class="timeline-body">
                <p>Added integration tests for webhook signature verification and event processing. Tested with Printful sandbox environment.</p>

                <div class="verification">
                    <div class="verify-item">
                        <span class="verify-icon">✓</span>
                        <div class="verify-content">
                            <span class="verify-label">Tests</span>
                            <span class="verify-value">156/156</span>
                            <span class="verify-delta">+14 new</span>
                        </div>
                    </div>
                    <div class="verify-item">
                        <span class="verify-icon">✓</span>
                        <div class="verify-content">
                            <span class="verify-label">Lint</span>
                            <span class="verify-value">0 errors</span>
                        </div>
                    </div>
                    <div class="verify-item">
                        <span class="verify-icon">✓</span>
                        <div class="verify-content">
                            <span class="verify-label">Build</span>
                            <span class="verify-value">4.1s</span>
                        </div>
                    </div>
                    <div class="verify-item">
                        <span class="verify-icon">✓</span>
                        <div class="verify-content">
                            <span class="verify-label">Types</span>
                            <span class="verify-value">Pass</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ASSUMPTIONS -->
    <div class="assumptions">
        <div class="assumptions-header" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="assumptions-title">
                <span>◆</span>
                Assumptions Made (3)
            </div>
            <span class="assumptions-toggle">‹</span>
        </div>
        <div class="assumptions-body">
            <div class="assumption-item">
                <span class="assumption-bullet">→</span>
                <span class="assumption-text"><strong>Printful webhook format</strong> — assumed JSON payload with event type and data fields based on Printful API documentation</span>
            </div>
            <div class="assumption-item">
                <span class="assumption-bullet">→</span>
                <span class="assumption-text"><strong>Environment variable naming</strong> — followed existing pattern of <code>STRIPE_WEBHOOK_SECRET</code> for consistency</span>
            </div>
            <div class="assumption-item">
                <span class="assumption-bullet">→</span>
                <span class="assumption-text"><strong>Notification timing</strong> — assumed email notifications should be sent immediately when order ships, not batched</span>
            </div>
        </div>
    </div>

    <!-- POTENTIAL QUESTIONS -->
    <div class="questions">
        <div class="questions-header" onclick="this.parentElement.classList.toggle('collapsed')">
            <div class="questions-title">
                <span>?</span>
                Potential Questions (4)
            </div>
            <span class="questions-toggle">‹</span>
        </div>
        <div class="questions-body">
            <div class="question-item">
                <span class="question-bullet">Q</span>
                <div class="question-content">
                    <div class="question-text">Why process webhooks asynchronously instead of synchronously?</div>
                    <div class="question-answer">Printful requires webhook acknowledgment within 5 seconds. Database updates and email notifications can take longer, so we acknowledge immediately and process in the background.</div>
                </div>
            </div>
            <div class="question-item">
                <span class="question-bullet">Q</span>
                <div class="question-content">
                    <div class="question-text">Will this break existing orders?</div>
                    <div class="question-answer">No — the webhook only updates orders that were created through Printful. Existing orders without Printful IDs are unaffected.</div>
                </div>
            </div>
            <div class="question-item">
                <span class="question-bullet">Q</span>
                <div class="question-content">
                    <div class="question-text">How do I test webhooks locally?</div>
                    <div class="question-answer">Use ngrok or similar tunneling service to expose your local server to Printful. The webhook handler logs all events for debugging.</div>
                </div>
            </div>
            <div class="question-item">
                <span class="question-bullet">Q</span>
                <div class="question-content">
                    <div class="question-text">What happens if a webhook fails?</div>
                    <div class="question-answer">Failed events are logged to console. Printful will retry the webhook up to 3 times with exponential backoff. Consider adding a dead-letter queue for production.</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    // Assumptions and Questions sections start expanded
</script>
</body>
</html>